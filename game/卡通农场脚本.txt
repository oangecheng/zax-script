
Dim mWinL, mWinT, mWinR, mWinB, mWinWidth, mWinHeight, mWinCenterX, mWinCenterY

Dim mLandPosX, mLandPosY, mWheafSeedPosX, mWheafSeedPosY, mKnifePosX, mKnifePosY
Dim mLandColumnCnt, mLandRowCnt

Dim mShopPosX, mShopPosY, mShelfPosX, mShelfPosY, mShelfGap

Dim mOffsetX, mOffsetY, mPicRatio

Call startTask()

Function startTask()
	Call init()
	Call moveToInitPos()

	// 开始种植之前判断一下有没有x号，有就关闭
	FindPic mWinL, mWinT, mWinR, mWinB, "Attachment:\close.bmp", mPicRatio, x, y
	If (x > 0) Then 
		MoveTo x, y
		LeftClick 1
		Delay 50
		Exit Function
	Else 
		Call startPlantWheaf()
		s = Plugin.GetSysInfo.GetTime()
		Call completeSell()
		c = Plugin.GetSysInfo.GetTime() - s
		d = 120000 - c
		Delay d
		Call harvest()
	End If	
End Function

Function reset()
    MoveTo mWinCenterX, mWinCenterY
    KeyDown "Ctrl", 1
    MouseWheel - 3 
    Delay 500
    KeyUp "Ctrl", 1
    Delay 500
    MoveTo 200, 200
    Delay 500
    LeftDown 1
    Delay 500
    MoveTo 400, 400
    Delay 500
    LeftUp 1
    MoveTo 200, 200
    Delay 500
    LeftDown 1
    Delay 500
    MoveTo 400, 400
    LeftUp 1
    Delay 500
End Function


Function moveToInitPos()
    Call reset()
    Call reset()
    Delay 1000
    MoveTo mWinCenterX, mWinCenterY
    Delay 100
    MouseWheel - 4 
    Delay 500
    MoveTo mWinCenterX, mWinCenterY
End Function

Function init()
    Call RunApp("C:\LeiDian\LDPlayer3.0\dnplayer.exe")  
    HWD = Plugin.Window.Find("LDPlayerMainFrame", 0)
    Call Plugin.Window.Size(HWD, 1280, 720)
    Delay 500
    Call Plugin.Window.Move(HWD, 0, 0)
    Delay 500
    wRect = Plugin.Window.GetWindowRect(HWD)

    
    Dim arr
    arr = Split(wRect, "|")
    mWinL = CInt(arr(0))
    mWinT = CInt(arr(1))
    mWinR= CInt(arr(2))
    mWinB = CInt(arr(3))
    mWinWidth = mWinR - mWinL
    mWinHeight = mWinB - mWinT
    mWinCenterX = mWinL + mWinWidth / 2
    mWinCenterY = mWinT + mWinHeight / 2
    
    mLandColumnCnt = 9
    mLandRowCnt = 4
    mOffsetX = 0
    mOffsetY = 0
    
    Call reset()
    Call reset()
    Call checkOffset()
    
    mPicRatio = 0.6
    
    mLandPosX = 740 + mOffsetX
    mLandPosY = 500 + mOffsetX
    mWheafSeedPosX = mLandPosX - 90
    mWheafSeedPosY = mLandPosY - 100
    mKnifePosX = mLandPosX - 160
    mKnifePosY = mLandPosY - 60
    mShopPosX = mLandPosX - 200
    mShopPosY = mLandPosY
    mShelfPosX = 222
    mShelfPosY = 331
    mShelfGap = 130  
End Function


Function checkOffset()
    Delay 2000
    fh = Plugin.File.OpenFile("C:\Users\orang\Desktop\conf.txt")
    line = Plugin.File.ReadLine(fh)
    xy = Split(line, "|")
    x = CInt(xy(0))
    y = CInt(xy(1))
    FindPic 400, 400, 700, 700, "Attachment:\location.bmp", 0.6, cx, cy
    If (cx > 0) Then 
        mOffsetX = cx - x
        mOffsetY = cy - y
    End If
    TracePrint ""&mOffsetX
    Call Plugin.File.CloseFile(fh)  
End Function


Function visitEveryLand()
    j = mLandRowCnt
    qx = mLandPosX
    qy = mLandPosY
    Do While j > 0
        i = mLandColumnCnt
        px = qx
        py = qy
        Do While i > 0
            Delay 100
            MoveTo px, py
            px = px + 33
            py = py - 17
            i=i-1
        Loop
        qx = qx - 33
        qy = qy - 17
        j=j-1
    Loop
End Function



Function moveToKnife()
    Call moveToInitPos()
    MoveTo mLandPosX, mLandPosY
    LeftClick 1
    Delay 500
    MoveTo mKnifePosX, mKnifePosY
End Function

Function moveToShel()
    Call moveToInitPos()
    MoveTo mShopPosX, mShopPosY
    LeftClick 1
    Delay 500
End Function


Function startPlantWheaf()
    Call moveToInitPos()
    MoveTo mLandPosX, mLandPosY
    LeftClick 1
    Delay 500
    MoveTo mWheafSeedPosX, mWheafSeedPosY
    Delay 200
    LeftDown 1
    Delay 200
    Call visitEveryLand()
    LeftUp 1
    Delay 100
    timeCost = 0
End Function

Function harvest()
    Call moveToKnife()
    Delay 200
    LeftDown 1
    Delay 200
    Call visitEveryLand()
    LeftUp 1
    Delay 100
End Function

Function sellOne()
    flag = True
    hasWheaf = True
    Do While flag
        FindPic mWinL, mWinT, mWinR, mWinB, "Attachment:\empty.bmp", mPicRatio, x, y
        If (x > 0 and y > 0) Then 
            MoveTo x+40, y+20
            Call wait(100)
            LeftClick 1
            Call wait(500)
            FindPic mWinL, mWinT, mWinR, mWinB, "Attachment:\wheaf.bmp", mPicRatio, intX, intY
            If (intX < 470 and intX > 0 and intY < 280) Then 
                MoveTo intX+30, intY+15
                Call wait(100)
                LeftClick 1
                Call wait(100)
                MoveTo 920, 665
                LeftClick 1
                Call wait(500)
            Else 
            	MoveTo 1060, 100
            	LeftClick 1
            	flag = False
            	hasWheaf = False
            	Call wait(500)
            End If
        Else 
            flag = False
        End If	
    Loop
    sellOne = hasWheaf
End Function

Function sell()	
    hasWheaf = sellOne()
    If (hasWheaf) Then 
    	Call moveNextShelArea()
    	Call sellOne()
    End If
    Call closeShel()	
End Function

Function ad()
	FindPic mWinL, mWinT, mWinR, mWinB, "Attachment:\wheaf1.bmp", mPicRatio, xx, yy
	If (xx > 0) Then 
		MoveTo mShelfPosX, mShelfPosY
    	LeftClick 1
   	 	Call wait(500)
   	Else 
   		Call closeShel()
   		Exit Function
	End If
 
    FindPic mWinL, mWinT, mWinR, mWinB, "Attachment:\ad.bmp", mPicRatio, x, y
    If (x > 0) Then 
        MoveTo 760, 360
        Delay 100
        LeftClick 1
        Call wait(100)
        MoveTo 620, 520
        LeftClick 1
        Call wait(500)
    Else 
        MoveTo 900, 120
        Delay 100
        LeftClick 1
        Call wait(500)
    End If
    Call closeShel()
End Function

Function closeShel()
    MoveTo 1050, 110
    LeftClick 1
    Call wait(1000)	
End Function

Function moveNextShelArea()
    MoveTo 1100, 330
    Delay 50
    LeftDown 1
    Delay 1000
    MoveTo mShelfPosX, shellInY
    Call wait(1000)
    LeftUp 1
    MoveTo mWinCenterX,mWinCenterY
    Call wait(500)
End Function

Function soldoutOne()
    flag = True
    Do While flag
        FindPic mWinL, mWinT, mWinR, mWinB, "Attachment:\soldout.bmp", mPicRatio, x, y
        If (x > 0) Then 
            MoveTo x + 35, y + 35
            LeftClick 1
            Call wait(500)
        Else 
            flag = False
        End If
    Loop
End Function

Function soldout()
    Call soldoutOne()
    Call moveNextShelArea()
    Call soldoutOne()
    Call closeShel()
End Function

Function wait(time)
    Delay time
    timeCost = timeCost + time
End Function

Function completeSell()
	Call moveToShel()
    Call soldout()
    Call moveToShel()
    Call sell()
    Call moveToShel()
    Call ad()
End Function


Event Form1.Button1.Click
    Call init()
    Call moveToInitPos()
    Call startPlantWheaf()
    Call completeSell()
End Event


Event Form1.Button2.Click
	Call init()
	Call moveToInitPos()
	Call harvest()
End Event


Event Form1.Button3.Click
	Call init()
    Call moveToInitPos()
    MoveTo mLandPosX, mLandPosY
    LeftClick 1
End Event

Function auto()
   	
End Function


Event Form1.Button4.Click

End Event